name: Deploy to ECS with Task Definition Update

on:
  push:
    branches: [ main ]

env:
  ECR_REPOSITORY: simple-web-server
  ECS_SERVICE: simple-web-service
  ECS_CLUSTER: simple-web-cluster
  ECS_TASK_DEFINITION: simple-web-task
  CONTAINER_NAME: simple-web-container

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      run: |
        aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

    - name: Build and push Docker image
      run: |
        IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-8)
        IMAGE_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
        
        echo "ğŸ”¨ Building Docker image with tag: $IMAGE_TAG"
        docker build -t $IMAGE_URI .
        
        echo "ğŸ“¦ Pushing image to ECR..."
        docker push $IMAGE_URI
        
        echo "NEW_IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
        echo "âœ… Image pushed: $IMAGE_URI"

    - name: Create new task definition
      run: |
        # í˜„ì¬ ì‘ì—… ì •ì˜ ê°€ì ¸ì˜¤ê¸°
        echo "ğŸ“‹ Getting current task definition..."
        aws ecs describe-task-definition \
          --task-definition $ECS_TASK_DEFINITION \
          --query taskDefinition > current-task-def.json
        
        # ìƒˆ ì‘ì—… ì •ì˜ ìƒì„± (ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±° ë° ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸)
        echo "ğŸ”„ Creating new task definition with image: $NEW_IMAGE_URI"
        cat current-task-def.json | jq --arg NEW_IMAGE "$NEW_IMAGE_URI" '
          del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy) |
          .containerDefinitions[0].image = $NEW_IMAGE
        ' > new-task-def.json
        
        # ìƒˆ ì‘ì—… ì •ì˜ ë“±ë¡
        NEW_REVISION=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-def.json \
          --query 'taskDefinition.revision' \
          --output text)
        
        echo "NEW_TASK_DEF_REVISION=$NEW_REVISION" >> $GITHUB_ENV
        echo "âœ… New task definition registered: $ECS_TASK_DEFINITION:$NEW_REVISION"

    - name: Update ECS service
      run: |
        echo "ğŸš€ Updating ECS service with new task definition..."
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --task-definition $ECS_TASK_DEFINITION:$NEW_TASK_DEF_REVISION \
          --no-cli-pager
        
        echo "âœ… Service update triggered!"
        echo "ğŸŒ New deployment in progress with image: $NEW_IMAGE_URI"
        
        # ë°°í¬ ìƒíƒœ ê°„ë‹¨ í™•ì¸
        sleep 30
        echo "ğŸ“Š Current service status:"
        aws ecs describe-services \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE \
          --query 'services[0].{RunningCount:runningCount,DesiredCount:desiredCount,TaskDefinition:taskDefinition}' \
          --output table
